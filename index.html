<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GitHub Gist Notepad</title>
<style>
  textarea { width: 100%; height: 80vh; font-size: 16px; }
  button { padding: 10px; margin-top: 10px; }
</style>
</head>
<body>
<h1>GitHub Gist Notepad</h1>
<textarea id="note"></textarea>
<br>
<button id="save">Save</button>

<script>
const params = new URLSearchParams(window.location.search);
let token = params.get('token');
const gistIdKey = 'my-notepad-gist-id';
const textarea = document.getElementById('note');
const saveBtn = document.getElementById('save');

async function loadNote() {
  const gistId = localStorage.getItem(gistIdKey);
  if (!gistId || !token) return;
  const res = await fetch(`https://api.github.com/gists/${gistId}`, {
    headers: { Authorization: `token ${token}` }
  });
  if (!res.ok) return;
  const gist = await res.json();
  const fileName = Object.keys(gist.files)[0];
  textarea.value = gist.files[fileName].content;
}

async function saveNote() {
  if (!token) {
    alert('No token found! Please provide a GitHub Personal Access Token.');
    return;
  }
  let gistId = localStorage.getItem(gistIdKey);
  const content = textarea.value;

  if (gistId) {
    await fetch(`https://api.github.com/gists/${gistId}`, {
      method: 'PATCH',
      headers: {
        Authorization: `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ files: { 'note.txt': { content } } })
    });
    alert('Saved!');
  } else {
    const res = await fetch(`https://api.github.com/gists`, {
      method: 'POST',
      headers: {
        Authorization: `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        description: 'My GitHub Notepad',
        public: false,
        files: { 'note.txt': { content } }
      })
    });
    const gist = await res.json();
    localStorage.setItem(gistIdKey, gist.id);
    alert('Saved!');
  }
}

// If no token, redirect to OAuth then prompt for Personal Access Token
if (!token) {
  const clientId = 'Ov23lioWTvqkmOUtiogF';
  const oauthUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&scope=gist`;
  alert('Redirecting to GitHub OAuth. After authorizing, create a Personal Access Token with "gist" scope and paste it.');
  window.location.href = oauthUrl;
}

// Prompt user for token if still none
if (!token) {
  token = prompt("Enter your GitHub Personal Access Token (with 'gist' scope):");
}

loadNote();
saveBtn.addEventListener('click', saveNote);
</script>
</body>
</html>
